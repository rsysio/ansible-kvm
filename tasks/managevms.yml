---

  - name: reserve IP address
    template: src=dnsmasq.resv.j2 dest=/var/lib/libvirt/dnsmasq/{{ kvm_net.bridge.name }}.hostsfile
    become: true
    notify: dnsmasq_reload

  - meta: flush_handlers

  - name: get existing VMs
    shell: "virsh list --all | grep -v '^$' | awk 'NR>2 {print $2}'"
    register: existing_vms

  - name: print existing VMs
    debug: msg={{ item }}
    with_items: "{{ existing_vms.stdout_lines }}"

  - name: delete VMs
    include: del_vm.yml
    loop_control:
        loop_var: vm
    with_items: "{{ kvm_delete_vms }}"


  - name: manage VMs
    include: vm.yml
    loop_control:
        loop_var: vm
    with_items: "{{ kvm_vms }}"




